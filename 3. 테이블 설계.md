## 🎯 MySQL DBA 관점에서의 설계 원칙

```
💡 MySQL DBA가 고려해야 할 핵심 요소
├── InnoDB 스토리지 엔진 최적화
├── 인덱스 전략 (B-Tree, 복합 인덱스)
├── 파티셔닝 (RANGE, HASH, LIST)
├── 레플리케이션 (Master-Slave)
├── 커넥션 풀 및 락 최적화
├── 쿼리 캐시 및 버퍼 풀 튜닝
└── 백업/복구 (mysqldump, binlog)
```

## 🗃️ 핵심 테이블 설계 (8개)

### 1. users (사용자 마스터)
```sql
CREATE TABLE users (
    user_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    user_type ENUM('viewer', 'broadcaster', 'admin') DEFAULT 'viewer',
    status ENUM('active', 'suspended', 'deleted') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP NULL,
    
    PRIMARY KEY (user_id),
    UNIQUE KEY uk_users_username (username),
    UNIQUE KEY uk_users_email (email),
    KEY idx_users_type_status (user_type, status),
    KEY idx_users_created_date (created_at)
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='사용자 기본 정보';

-- MySQL DBA 포인트: 개인정보 보안
ALTER TABLE users 
ADD COLUMN email_encrypted VARBINARY(500) COMMENT 'AES 암호화된 이메일',
ADD COLUMN phone_encrypted VARBINARY(255) COMMENT 'AES 암호화된 전화번호';
```

### 2. broadcasters (방송인 정보)
```sql
CREATE TABLE broadcasters (
    broadcaster_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,
    channel_name VARCHAR(50) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    profile_image_url VARCHAR(500),
    banner_image_url VARCHAR(500),
    description TEXT,
    follower_count BIGINT UNSIGNED DEFAULT 0,
    total_views BIGINT UNSIGNED DEFAULT 0,
    verified TINYINT(1) DEFAULT 0,
    partnership_tier ENUM('none', 'affiliate', 'partner') DEFAULT 'none',
    revenue_share_rate DECIMAL(5,2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (broadcaster_id),
    UNIQUE KEY uk_broadcasters_user (user_id),
    UNIQUE KEY uk_broadcasters_channel (channel_name),
    KEY idx_broadcasters_follower_rank (follower_count DESC, verified),
    KEY idx_broadcasters_partnership (partnership_tier, verified),
    
    CONSTRAINT fk_broadcasters_user 
        FOREIGN KEY (user_id) REFERENCES users(user_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='방송인 상세 정보';

-- MySQL DBA 포인트: 통계 컬럼 업데이트 최적화
-- follower_count, total_views는 별도 배치로 업데이트
```

### 3. categories (방송 카테고리)
```sql
CREATE TABLE categories (
    category_id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    category_name VARCHAR(100) NOT NULL,
    parent_category_id INT UNSIGNED NULL,
    sort_order INT DEFAULT 0,
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (category_id),
    UNIQUE KEY uk_categories_name (category_name),
    KEY idx_categories_parent (parent_category_id),
    KEY idx_categories_active (is_active, sort_order),
    
    CONSTRAINT fk_categories_parent 
        FOREIGN KEY (parent_category_id) REFERENCES categories(category_id)
        ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='방송 카테고리 (계층구조)';
```

### 4. streams (방송 세션)
```sql
CREATE TABLE streams (
    stream_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    broadcaster_id BIGINT UNSIGNED NOT NULL,
    category_id INT UNSIGNED NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    thumbnail_url VARCHAR(500),
    stream_key VARCHAR(64) NOT NULL,
    status ENUM('live', 'ended', 'error') DEFAULT 'live',
    quality ENUM('480p', '720p', '1080p', '4K') DEFAULT '720p',
    language CHAR(2) DEFAULT 'ko',
    is_mature TINYINT(1) DEFAULT 0,
    max_viewers INT UNSIGNED DEFAULT 0,
    total_viewers BIGINT UNSIGNED DEFAULT 0,
    started_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (stream_id),
    UNIQUE KEY uk_streams_key (stream_key),
    KEY idx_streams_broadcaster (broadcaster_id, started_at DESC),
    KEY idx_streams_category_live (category_id, status, started_at DESC),
    KEY idx_streams_live (status, started_at DESC),
    KEY idx_streams_language (language, status),
    
    CONSTRAINT fk_streams_broadcaster 
        FOREIGN KEY (broadcaster_id) REFERENCES broadcasters(broadcaster_id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_streams_category 
        FOREIGN KEY (category_id) REFERENCES categories(category_id)
        ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='방송 세션 정보'
  PARTITION BY RANGE (YEAR(started_at) * 100 + MONTH(started_at)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    PARTITION p202503 VALUES LESS THAN (202504),
    PARTITION p202504 VALUES LESS THAN (202505),
    PARTITION p202505 VALUES LESS THAN (202506),
    PARTITION p202506 VALUES LESS THAN (202507),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 5. current_viewers (실시간 시청자 통계)
```sql
CREATE TABLE current_viewers (
    stream_id BIGINT UNSIGNED NOT NULL,
    viewer_count INT UNSIGNED NOT NULL DEFAULT 0,
    peak_viewers INT UNSIGNED NOT NULL DEFAULT 0,
    unique_viewers_today BIGINT UNSIGNED NOT NULL DEFAULT 0,
    chat_messages_count BIGINT UNSIGNED DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_peak_at TIMESTAMP NULL,
    
    PRIMARY KEY (stream_id),
    KEY idx_current_viewers_ranking (viewer_count DESC),
    KEY idx_current_viewers_peak (peak_viewers DESC),
    KEY idx_current_viewers_updated (last_updated),
    
    CONSTRAINT fk_current_viewers_stream 
        FOREIGN KEY (stream_id) REFERENCES streams(stream_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='실시간 시청자 통계 (Redis 동기화)';

-- MySQL DBA 포인트: 고빈도 업데이트를 위한 최적화
-- 별도 테이블스페이스 할당 고려
-- ALTER TABLE current_viewers TABLESPACE high_io_tablespace;
```

### 6. viewer_history (시청자수 히스토리)
```sql
CREATE TABLE viewer_history (
    history_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    stream_id BIGINT UNSIGNED NOT NULL,
    viewer_count INT UNSIGNED NOT NULL,
    peak_viewers INT UNSIGNED NOT NULL,
    recorded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (history_id, recorded_at),
    KEY idx_viewer_history_stream_time (stream_id, recorded_at DESC),
    KEY idx_viewer_history_recorded (recorded_at),
    
    CONSTRAINT fk_viewer_history_stream 
        FOREIGN KEY (stream_id) REFERENCES streams(stream_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='시청자수 히스토리 (5분 간격)'
  PARTITION BY RANGE (YEAR(recorded_at) * 100 + MONTH(recorded_at)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    PARTITION p202503 VALUES LESS THAN (202504),
    PARTITION p202504 VALUES LESS THAN (202505),
    PARTITION p202505 VALUES LESS THAN (202506),
    PARTITION p202506 VALUES LESS THAN (202507),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- MySQL DBA 포인트: 파티션 자동 관리
-- 오래된 파티션 자동 삭제 프로시저 필요
```

### 7. user_sessions (사용자 세션)
```sql
CREATE TABLE user_sessions (
    session_id VARCHAR(64) NOT NULL,
    user_id BIGINT UNSIGNED NULL,
    stream_id BIGINT UNSIGNED NOT NULL,
    ip_address VARBINARY(16) NOT NULL, -- IPv4/IPv6 지원
    user_agent TEXT,
    country_code CHAR(2),
    city VARCHAR(100),
    started_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMP NULL,
    duration_seconds INT UNSIGNED GENERATED ALWAYS AS 
        (CASE 
            WHEN ended_at IS NULL THEN TIMESTAMPDIFF(SECOND, started_at, NOW())
            ELSE TIMESTAMPDIFF(SECOND, started_at, ended_at)
        END) STORED,
    is_anonymous TINYINT(1) DEFAULT 1,
    
    PRIMARY KEY (session_id, started_at),
    KEY idx_user_sessions_user (user_id, started_at DESC),
    KEY idx_user_sessions_stream (stream_id, started_at DESC),
    KEY idx_user_sessions_cleanup (started_at),
    KEY idx_user_sessions_ip (ip_address),
    
    CONSTRAINT fk_user_sessions_user 
        FOREIGN KEY (user_id) REFERENCES users(user_id) 
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_user_sessions_stream 
        FOREIGN KEY (stream_id) REFERENCES streams(stream_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='사용자 세션 (GDPR 30일 보관)'
  PARTITION BY RANGE (TO_DAYS(started_at)) (
    PARTITION p20250810 VALUES LESS THAN (TO_DAYS('2025-08-11')),
    PARTITION p20250811 VALUES LESS THAN (TO_DAYS('2025-08-12')),
    PARTITION p20250812 VALUES LESS THAN (TO_DAYS('2025-08-13')),
    PARTITION p20250813 VALUES LESS THAN (TO_DAYS('2025-08-14')),
    PARTITION p20250814 VALUES LESS THAN (TO_DAYS('2025-08-15')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 8. daily_statistics (일별 통계)
```sql
CREATE TABLE daily_statistics (
    stat_date DATE NOT NULL,
    stream_id BIGINT UNSIGNED NOT NULL,
    broadcaster_id BIGINT UNSIGNED NOT NULL,
    category_id INT UNSIGNED NULL,
    total_viewers BIGINT UNSIGNED NOT NULL DEFAULT 0,
    unique_viewers BIGINT UNSIGNED NOT NULL DEFAULT 0,
    peak_viewers INT UNSIGNED NOT NULL DEFAULT 0,
    avg_viewers DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    total_watch_time BIGINT UNSIGNED NOT NULL DEFAULT 0,
    bounce_rate DECIMAL(5,2) DEFAULT 0.00,
    engagement_score DECIMAL(5,2) DEFAULT 0.00,
    revenue DECIMAL(15,2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (stat_date, stream_id),
    KEY idx_daily_stats_stream (stream_id, stat_date DESC),
    KEY idx_daily_stats_broadcaster (broadcaster_id, stat_date DESC),
    KEY idx_daily_stats_category (category_id, stat_date DESC),
    KEY idx_daily_stats_performance (stat_date, peak_viewers DESC),
    
    CONSTRAINT fk_daily_stats_stream 
        FOREIGN KEY (stream_id) REFERENCES streams(stream_id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_daily_stats_broadcaster 
        FOREIGN KEY (broadcaster_id) REFERENCES broadcasters(broadcaster_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='일별 집계 통계'
  PARTITION BY RANGE (YEAR(stat_date) * 10000 + MONTH(stat_date) * 100 + DAY(stat_date)) (
    PARTITION p20250801 VALUES LESS THAN (20250802),
    PARTITION p20250802 VALUES LESS THAN (20250803),
    PARTITION p20250803 VALUES LESS THAN (20250804),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);



┌───────────────────────┬─────────────┬────────────────────────────────────────────┬──────────────────────────────────────┐
│ 테이블명               │ 정규화 수준 │ 적용 이유                                   │ 비정규화/중복 허용 이유               │
├───────────────────────┼─────────────┼────────────────────────────────────────────┼──────────────────────────────────────┤
│ users                  │ 3NF         │ 사용자 기본정보, 변경·무결성 중요            │ 없음                                  │
│ broadcasters           │ 3NF         │ 방송인 세부정보, FK로 users 참조             │ 없음                                  │
│ categories             │ 3NF         │ 계층형 카테고리 구조, 무결성 우선             │ 없음                                  │
│ streams                │ 3NF         │ 방송 세션, FK로 broadcaster·category 참조    │ 없음                                  │
│ current_viewers        │ 비정규화    │ 조회 성능 우선, viewer_count·peak 등 중복저장 │ JOIN 없이 한 번에 조회 목적           │
│ viewer_history         │ 3NF         │ 시청자수 이력 저장, PK+시간 기반 파티션       │ 없음                                  │
│ user_sessions          │ 3NF         │ 접속 세션 로그, PK+날짜 기반 파티션           │ 없음                                  │
│ daily_statistics       │ 비정규화    │ 집계결과를 그대로 저장                        │ 집계 연산 없이 즉시 리포트 조회 목적  │
└───────────────────────┴─────────────┴────────────────────────────────────────────┴──────────────────────────────────────┘



1. 기능별 책임 분리

  users / broadcasters / categories
  → 사용자·방송인·카테고리의 기본 마스터 데이터를 관리. 변경이 적고 조회 중심이라 트랜잭션 부하가 적음.

  streams
  → 방송 세션(방송 시작~종료까지)을 기록. 파티셔닝을 통해 기간별 관리 용이.

  current_viewers
  → Redis와 동기화되는 실시간 카운트 전용 테이블. 고빈도 업데이트를 처리하기 위해 별도 테이블로 분리.

  viewer_history
  → 5분 단위 스냅샷 저장용. current_viewers의 이력을 장기 보관·분석 가능하도록 설계.

  user_sessions
  → 개별 시청자의 접속 세션 정보 관리 (GDPR 등 보존 기간 관리). 대량 데이터이므로 일 단위 파티셔닝.

  daily_statistics
  → 집계·리포팅 전용. OLAP 성격이라 OLTP 테이블과 분리해 조회 부하가 실시간 데이터에 영향 주지 않음.

2. 성능·확장성 고려

  실시간 변경(current_viewers)과 대량 조회/분석(viewer_history, daily_statistics)을 분리
  → 트랜잭션 락 경합 방지, Aurora Writer 부하 최소화.

  파티셔닝
  → streams·viewer_history·user_sessions·daily_statistics에 적용해 대용량 데이터 관리·삭제·백업을 빠르게 수행.

  인덱스 전략 최적화
  → 각 테이블별 접근 패턴에 맞춘 복합 인덱스 설계로 쿼리 효율 극대화.

3. 데이터 수명주기 관리

  단기 보관: current_viewers, user_sessions (실시간·단기성 데이터)

  중기 보관: viewer_history (월 단위 파티션)

  장기 보관: daily_statistics (년·월·일 단위 파티션)
  → 데이터 아카이빙·삭제 정책을 수명주기에 맞춰 설계.

  즉, 8개로 나눈 이유는

  "실시간 처리, 이력 저장, 집계/분석을 각각 독립시켜 성능과 유지보수성을 동시에 확보"
  라는 설계 원칙 때문입니다.

