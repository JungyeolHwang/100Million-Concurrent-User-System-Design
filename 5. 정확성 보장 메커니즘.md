정확성 보장 메커니즘 (개정)

1차 안전장치 — 중복 방지 Set(실시간 동접용)

    live:users:{stream}은 집합(Set) 으로 관리합니다.
    동일 사용자가 새로고침·재연결·중복 탭을 열어도 Set에는 한 번만 포함되어 실시간 동접이 부풀지 않습니다.

2차 안전장치 — 세션 기반 퇴장 정합성(Heartbeat + TTL)

    각 탭/연결마다 hb:{session}(TTL 60초)로 살아있는 세션만 유지하고, 만료되면 자동 퇴장 처리합니다.

    예외(브라우저 비정상 종료 등)도 최대 60초 내 정리되어 과소/과대 집계를 방지합니다.

(참고) 일일 유니크는 별도 지표

    uniq:users:{stream}:{yyyymmdd}는 “오늘 본 사람 수” 통계용일 뿐, 실시간 동접에는 영향 주지 않습니다.

    즉, 유저가 나갔다가 다시 들어오면 실시간 동접은 +1 -1 +1로 반영되고, 일일 유니크는 1회로 유지됩니다.


자동 정합성 검증/복구

    1분마다 WebSocket 서버의 실제 연결 수(서버 내부 카운트)와 Redis Set의 현재 인원을 비교해 오차가 10%↑면 자동 복구(세션 진실원장 기준 재빌드)를 수행합니다.



------------------------------------------------------------------------------------------

Redis 키/동작 요약 (수정 반영)


실시간 동접(현원)

    유저 기준 Set: live:users:{stream}

        입장: SADD live:users:{sid} {uid}

        퇴장: (유저의 모든 탭이 닫혔을 때) SREM live:users:{sid} {uid}

        현재 시청자수: SCARD live:users:{sid}

    유저-탭 세션 추적(멀티 탭 구분):

        live:tabs:{sid}:{uid} (멤버 = {session})

        입장: SADD live:tabs:{sid}:{uid} {sess} → 처음 탭일 때만 SADD live:users...

        탭 퇴장: SREM live:tabs:{sid}:{uid} {sess} → SCARD == 0이면 SREM live:users...


퇴장 정합성(2차 안전장치)

    Heartbeat/TTL:

    하트비트: SET hb:{sess} 1 EX 60 (30초마다 갱신)

    만료대상 인덱스: ZADD hb:deadlines {now+60} {sess}

    스위퍼(주기 실행): ZRANGEBYSCORE hb:deadlines -inf {now} → 만료 세션 일괄 퇴장

    효과: close 이벤트 누락/네트워크 플랩에도 최대 60초 내 정리


일일 유니크(통계 전용)

    일별 Set: uniq:users:{sid}:{yyyymmdd}

    입장 시 기록: SADD uniq:users:{sid}:{yyyymmdd} {uid}

    실시간 동접과 무관, 통계/리포트에서만 사용

    필요한 보존기간만 EXPIREAT로 만료 설정


자동 정합성 검증/복구

    서버별 실연결 보고: HSET ws:count:{server} {sid} {local_count}(1분 주기)

    비교: sum(HGET ...) ↔ SCARD live:users:{sid}

    오차율 ≥ 10% → 복구

    방법 A: live:tabs 기준으로 live:users 재빌드

    방법 B: 각 서버가 보유한 세션 목록을 PUB/SUB로 브로드캐스트해 재동기화